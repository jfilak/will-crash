#!/bin/bash

# exit on any failure
set -e

KERNELBUILDDIR=${1:-}

if [ -z "$KERNELBUILDDIR" ]; then
    LATESTKERNELDIR="/lib/modules/`uname -r`/build"
    RUNNINGKERNELDIR="/usr/src/kernels/`uname -r`/"
    for KD in $LATESTKERNELDIR $RUNNINGKERNELDIR; do
        if [ -d $KD ]; then
            KERNELBUILDDIR=$KD
            break
        fi
    done

    if [ -z "$KERNELBUILDDIR" ]; then
        echo "Kernel build tree not found"
        echo "Please install the kernel-devel-`uname -r` package"
        exit 1
    fi
fi

# look in the current directory first
SRCDIR="`pwd`/will_oops_kmod"
if [ ! -d "$SRCDIR" ]; then
    SRCDIR=@KMODSRC@
fi

TMPDIR=`mktemp -d /tmp/will_oops.XXXXXXXXXX`
trap "rm -rf $TMPDIR" EXIT

cd $TMPDIR
cp $SRCDIR/{will_oops.c,Makefile} .

echo "Building kernel module ..."
make KERNELDIR=$KERNELBUILDDIR

echo "Loading the module ..."
insmod will_oops.ko

echo "Removing the module..."
rmmod will_oops
